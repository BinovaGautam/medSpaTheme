<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>✅ Tokenization Fix Verification Test</title>
    <style>
        /*
         * COMPREHENSIVE TOKENIZATION FIX VERIFICATION
         * Testing the complete inheritance chain fix for button BG vs text color inconsistency
         */
        :root {
            /* Test baseline tokens */
            --color-primary: #2563eb;
            --color-primary-contrast: #ffffff;
            --color-secondary: #10b981;
            --color-secondary-contrast: #ffffff;
            --color-accent: #f59e0b;
            --color-accent-contrast: #ffffff;
            --color-surface: #ffffff;
            --color-surface-secondary: #f8fafc;
            --color-text-primary: #0f172a;
            --color-text-inverse: #ffffff;
            --color-border: #e2e8f0;
            --color-border-focus: #2563eb;

            /* Component-level tokens (these should inherit from foundation tokens) */
            --component-bg-color: var(--color-surface);
            --component-text-color: var(--color-text-primary);
            --component-border-color: var(--color-border);

            /* Primary component variant tokens */
            --component-bg-color-primary: var(--color-primary);
            --component-text-color-primary: var(--color-primary-contrast);
            --component-border-color-primary: var(--color-primary);

            /* Secondary component variant tokens */
            --component-bg-color-secondary: var(--color-secondary);
            --component-text-color-secondary: var(--color-secondary-contrast);
            --component-border-color-secondary: var(--color-secondary);

            /* Accent component variant tokens */
            --component-bg-color-accent: var(--color-accent);
            --component-text-color-accent: var(--color-accent-contrast);
            --component-border-color-accent: var(--color-accent);

            /* Palette tokens (for extra inheritance layer) */
            --palette-primary: var(--color-primary);
            --palette-primary-contrast: var(--color-primary-contrast);
            --palette-secondary: var(--color-secondary);
            --palette-surface: var(--color-surface);
        }

        /* Base styling */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 2rem;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 3rem;
            padding-bottom: 2rem;
            border-bottom: 2px solid #eee;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            color: #27ae60;
        }

        .test-section {
            margin: 2rem 0;
            padding: 1.5rem;
            border: 2px solid #ddd;
            border-radius: 12px;
            background: #fafafa;
        }

        .test-section h2 {
            color: #2c3e50;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* TOKENIZATION-AWARE COMPONENT PATTERN */
        .tokenized-component {
            color: var(--component-text-color, var(--color-text-primary));
            background-color: var(--component-bg-color, var(--color-surface));
            border: 2px solid var(--component-border-color, var(--color-border));
            padding: 1rem;
            border-radius: 8px;
            transition: all 0.3s ease;
            margin: 0.5rem;
            font-weight: 500;
            cursor: pointer;
            display: inline-block;
            text-decoration: none;
            min-width: 120px;
            text-align: center;
        }

        /* Primary variant using component-level token override */
        .tokenized-component--primary {
            --component-bg-color: var(--component-bg-color-primary);
            --component-text-color: var(--component-text-color-primary);
            --component-border-color: var(--component-border-color-primary);
        }

        /* Secondary variant using component-level token override */
        .tokenized-component--secondary {
            --component-bg-color: var(--component-bg-color-secondary);
            --component-text-color: var(--component-text-color-secondary);
            --component-border-color: var(--component-border-color-secondary);
        }

        /* Accent variant using component-level token override */
        .tokenized-component--accent {
            --component-bg-color: var(--component-bg-color-accent);
            --component-text-color: var(--component-text-color-accent);
            --component-border-color: var(--component-border-color-accent);
        }

        /* TRADITIONAL BUTTON PATTERNS FOR COMPARISON */
        .traditional-button {
            background-color: #2563eb;
            color: white;
            border: 2px solid #2563eb;
            padding: 1rem;
            border-radius: 8px;
            margin: 0.5rem;
            font-weight: 500;
            cursor: pointer;
            display: inline-block;
            text-decoration: none;
            min-width: 120px;
            text-align: center;
        }

        .traditional-button--secondary {
            background-color: #10b981;
            border-color: #10b981;
        }

        /* MIXED APPROACH BUTTONS (some tokenized, some not) */
        .mixed-button {
            background-color: var(--color-primary);
            color: white;
            border: 2px solid #2563eb; /* hardcoded border */
            padding: 1rem;
            border-radius: 8px;
            margin: 0.5rem;
            font-weight: 500;
            cursor: pointer;
            display: inline-block;
            text-decoration: none;
            min-width: 120px;
            text-align: center;
        }

        /* Controls styling */
        .controls {
            margin: 2rem 0;
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .control-btn {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(39, 174, 96, 0.3);
        }

        .control-btn.danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .control-btn.warning {
            background: linear-gradient(135deg, #f39c12, #e67e22);
        }

        /* Test results styling */
        .test-results {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-radius: 8px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            overflow-x: auto;
            border-left: 4px solid #27ae60;
        }

        .comparison-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin: 2rem 0;
        }

        .comparison-section {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            border: 2px solid #ddd;
        }

        .comparison-section h3 {
            margin-bottom: 1rem;
            color: #2c3e50;
        }

        .status-indicator {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }

        .status-pass {
            background: #d4edda;
            color: #155724;
        }

        .status-fail {
            background: #f8d7da;
            color: #721c24;
        }

        .status-partial {
            background: #fff3cd;
            color: #856404;
        }

        .footer-info {
            margin-top: 3rem;
            padding-top: 2rem;
            border-top: 1px solid #ecf0f1;
            text-align: center;
            color: #7f8c8d;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>✅ Tokenization Fix Verification Test</h1>
            <p class="subtitle">Complete Inheritance Chain Testing for Button BG vs Text Color Fix</p>
            <div style="background: linear-gradient(135deg, #27ae60, #2ecc71); color: white; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.9rem; font-weight: 600; margin-top: 1rem;">
                🎯 TESTING: Visual Customizer Complete Token Inheritance Fix
            </div>
        </div>

        <div class="test-section">
            <h2>🧪 Test Components</h2>
            <p><strong>These components test the complete tokenization inheritance chain:</strong></p>

            <div class="comparison-grid">
                <div class="comparison-section">
                    <h3>✅ Tokenization-Aware Components</h3>
                    <p>Using component-level token inheritance pattern</p>
                    <div class="tokenized-component" data-testid="tokenized-default">Default Component</div>
                    <div class="tokenized-component tokenized-component--primary" data-testid="tokenized-primary">Primary Component</div>
                    <div class="tokenized-component tokenized-component--secondary" data-testid="tokenized-secondary">Secondary Component</div>
                    <div class="tokenized-component tokenized-component--accent" data-testid="tokenized-accent">Accent Component</div>
                </div>

                <div class="comparison-section">
                    <h3>❌ Traditional Hard-coded Buttons</h3>
                    <p>Using fixed color values (will NOT update)</p>
                    <div class="traditional-button" data-testid="traditional-primary">Traditional Primary</div>
                    <div class="traditional-button traditional-button--secondary" data-testid="traditional-secondary">Traditional Secondary</div>
                </div>

                <div class="comparison-section">
                    <h3>⚠️ Mixed Approach Buttons</h3>
                    <p>Partially tokenized (inconsistent updates)</p>
                    <div class="mixed-button" data-testid="mixed-primary">Mixed Primary</div>
                </div>
            </div>
        </div>

        <div class="test-section">
            <h2>🔬 Automated Tests</h2>
            <div class="controls">
                <button class="control-btn" onclick="runInheritanceChainTest()">🔍 Test Inheritance Chain</button>
                <button class="control-btn" onclick="simulateVisualCustomizerUpdate()">🎨 Simulate Customizer Update</button>
                <button class="control-btn" onclick="validateTokenCascade()">⚡ Validate Token Cascade</button>
                <button class="control-btn" onclick="debugVisualCustomizerDetailed()">🔬 Debug Customizer (Enhanced)</button>
                <button class="control-btn" onclick="demonstrateFixFromCleanBaseline()">🎯 Demo Fix From Clean Baseline</button>
                <button class="control-btn warning" onclick="testEdgeCases()">🧩 Test Edge Cases</button>
                <button class="control-btn danger" onclick="resetToBaseline()">🔄 Reset to Baseline</button>
            </div>

            <div class="test-results" id="test-output">
✅ TOKENIZATION FIX VERIFICATION TEST READY

This test verifies that the Visual Customizer fix completely resolves:
1. Button background not updating with color changes
2. Text colors changing but button backgrounds remaining unchanged
3. After reload, only buttons retaining styling

Click any test button to start comprehensive verification.
            </div>
        </div>

        <div class="test-section">
            <h2>📊 Test Results Summary</h2>
            <div id="test-summary">
                <p>Test results will appear here after running tests...</p>
            </div>
        </div>

        <div class="footer-info">
            <p><strong>Purpose:</strong> Verify complete fix for tokenization inheritance issues identified in debug tool</p>
            <p><strong>Fix Implemented:</strong> Visual Customizer now generates all component-level tokens for complete inheritance chain</p>
        </div>
    </div>

    <script>
        // Test state tracking
        let testResults = {
            inheritanceChain: null,
            customizerUpdate: null,
            tokenCascade: null,
            edgeCases: null,
            timestamp: null
        };

        // Test color palettes
        const testPalettes = {
            original: {
                '--color-primary': '#2563eb',
                '--color-secondary': '#10b981',
                '--color-accent': '#f59e0b',
                '--color-surface': '#ffffff'
            },
            customized: {
                '--color-primary': '#dc2626',
                '--color-secondary': '#7c3aed',
                '--color-accent': '#059669',
                '--color-surface': '#f8fafc'
            }
        };

        /**
         * Test 1: Inheritance Chain Verification
         */
        function runInheritanceChainTest() {
            console.log('🔍 Testing tokenization inheritance chain...');

            let output = '🔍 INHERITANCE CHAIN TEST\n\n';
            testResults.timestamp = new Date().toISOString();

            // Test each component's inheritance chain
            const components = [
                { id: 'tokenized-default', expected: 'surface' },
                { id: 'tokenized-primary', expected: 'primary' },
                { id: 'tokenized-secondary', expected: 'secondary' },
                { id: 'tokenized-accent', expected: 'accent' }
            ];

            let passCount = 0;
            let totalTests = components.length;

            components.forEach(({ id, expected }) => {
                const element = document.querySelector(`[data-testid="${id}"]`);
                if (element) {
                    const computed = getComputedStyle(element);
                    const bgColor = computed.backgroundColor;
                    const textColor = computed.color;
                    const borderColor = computed.borderColor;

                    // Check if colors match expected inheritance
                    const isCorrect = validateInheritanceChain(bgColor, textColor, borderColor, expected);

                    if (isCorrect) {
                        passCount++;
                        output += `✅ ${id}: Inheritance chain CORRECT\n`;
                        output += `   BG: ${bgColor}\n   Text: ${textColor}\n   Border: ${borderColor}\n\n`;
                    } else {
                        output += `❌ ${id}: Inheritance chain BROKEN\n`;
                        output += `   BG: ${bgColor}\n   Text: ${textColor}\n   Border: ${borderColor}\n\n`;
                    }
                }
            });

            const passRate = (passCount / totalTests * 100).toFixed(1);
            output += `📊 INHERITANCE CHAIN TEST RESULTS:\n`;
            output += `   Passed: ${passCount}/${totalTests} (${passRate}%)\n`;
            output += `   Status: ${passCount === totalTests ? 'PASS ✅' : 'FAIL ❌'}\n`;

            testResults.inheritanceChain = {
                passed: passCount,
                total: totalTests,
                passRate: passRate,
                status: passCount === totalTests ? 'PASS' : 'FAIL'
            };

            document.getElementById('test-output').textContent = output;
            updateTestSummary();
        }

        /**
         * Test 2: Visual Customizer Update Simulation
         */
        function simulateVisualCustomizerUpdate() {
            console.log('🎨 Simulating Visual Customizer update...');

            let output = '🎨 VISUAL CUSTOMIZER UPDATE SIMULATION\n\n';

            // Capture before state
            output += 'BEFORE UPDATE:\n';
            const beforeState = captureComponentStates();
            output += formatComponentStates(beforeState);

            // Apply comprehensive token update (simulating fixed Visual Customizer)
            output += '\n🔄 APPLYING COMPLETE TOKEN UPDATE...\n';
            applyComprehensiveTokenUpdate();

            // Force DOM recalculation and wait for CSS propagation
            document.body.offsetHeight;

            // Use setTimeout to allow CSS custom properties to fully propagate
            setTimeout(() => {
                // Capture after state
                output += '\nAFTER UPDATE:\n';
                const afterState = captureComponentStates();
                output += formatComponentStates(afterState);

                // Analyze changes with enhanced detection
                output += '\n📊 CHANGE ANALYSIS:\n';
                const changeAnalysis = analyzeChangesEnhanced(beforeState, afterState);
                output += changeAnalysis.report;

                // Add detailed color comparison
                output += '\n🔍 DETAILED COLOR COMPARISON:\n';
                output += generateDetailedColorComparison(beforeState, afterState);

                testResults.customizerUpdate = {
                    changedComponents: changeAnalysis.changedCount,
                    totalComponents: changeAnalysis.totalCount,
                    status: changeAnalysis.changedCount > 0 ? 'PASS' : 'FAIL',
                    details: changeAnalysis.details
                };

                document.getElementById('test-output').textContent = output;
                updateTestSummary();
            }, 100); // Allow time for CSS custom property inheritance to complete
        }

        /**
         * Test 3: Token Cascade Validation
         */
        function validateTokenCascade() {
            console.log('⚡ Validating token cascade...');

            let output = '⚡ TOKEN CASCADE VALIDATION\n\n';

            // Check foundation tokens
            output += 'FOUNDATION TOKENS:\n';
            const foundationTokens = ['--color-primary', '--color-secondary', '--color-accent', '--color-surface'];
            let foundationValid = true;

            foundationTokens.forEach(token => {
                const value = getComputedStyle(document.documentElement).getPropertyValue(token);
                if (value.trim()) {
                    output += `  ✅ ${token}: ${value.trim()}\n`;
                } else {
                    output += `  ❌ ${token}: NOT SET\n`;
                    foundationValid = false;
                }
            });

            // Check component tokens
            output += '\nCOMPONENT TOKENS:\n';
            const componentTokens = [
                '--component-bg-color',
                '--component-text-color',
                '--component-border-color',
                '--component-bg-color-primary',
                '--component-text-color-primary',
                '--component-border-color-primary'
            ];
            let componentValid = true;

            componentTokens.forEach(token => {
                const value = getComputedStyle(document.documentElement).getPropertyValue(token);
                if (value.trim()) {
                    output += `  ✅ ${token}: ${value.trim()}\n`;
                } else {
                    output += `  ❌ ${token}: NOT SET\n`;
                    componentValid = false;
                }
            });

            // Check palette tokens
            output += '\nPALETTE TOKENS:\n';
            const paletteTokens = ['--palette-primary', '--palette-secondary', '--palette-surface'];
            let paletteValid = true;

            paletteTokens.forEach(token => {
                const value = getComputedStyle(document.documentElement).getPropertyValue(token);
                if (value.trim()) {
                    output += `  ✅ ${token}: ${value.trim()}\n`;
                } else {
                    output += `  ❌ ${token}: NOT SET\n`;
                    paletteValid = false;
                }
            });

            const cascadeValid = foundationValid && componentValid && paletteValid;
            output += `\n📊 CASCADE VALIDATION:\n`;
            output += `   Foundation: ${foundationValid ? 'VALID ✅' : 'INVALID ❌'}\n`;
            output += `   Component: ${componentValid ? 'VALID ✅' : 'INVALID ❌'}\n`;
            output += `   Palette: ${paletteValid ? 'VALID ✅' : 'INVALID ❌'}\n`;
            output += `   Overall: ${cascadeValid ? 'PASS ✅' : 'FAIL ❌'}\n`;

            testResults.tokenCascade = {
                foundation: foundationValid,
                component: componentValid,
                palette: paletteValid,
                status: cascadeValid ? 'PASS' : 'FAIL'
            };

            document.getElementById('test-output').textContent = output;
            updateTestSummary();
        }

        /**
         * Test 4: Edge Cases
         */
        function testEdgeCases() {
            console.log('🧩 Testing edge cases...');

            let output = '🧩 EDGE CASE TESTING\n\n';

            // Test 1: Token removal and fallback
            output += 'TEST 1: Token Removal Fallback\n';
            document.documentElement.style.removeProperty('--color-primary');
            document.body.offsetHeight;

            const primaryElement = document.querySelector('[data-testid="tokenized-primary"]');
            const computedBg = getComputedStyle(primaryElement).backgroundColor;
            const hasFallback = computedBg !== 'rgba(0, 0, 0, 0)' && computedBg !== 'transparent';

            output += `  Primary token removed: ${hasFallback ? 'Fallback works ✅' : 'No fallback ❌'}\n`;
            output += `  Computed background: ${computedBg}\n\n`;

            // Restore token
            document.documentElement.style.setProperty('--color-primary', '#2563eb');

            // Test 2: Invalid token values
            output += 'TEST 2: Invalid Token Values\n';
            document.documentElement.style.setProperty('--color-primary', 'invalid-color');
            document.body.offsetHeight;

            const invalidBg = getComputedStyle(primaryElement).backgroundColor;
            const handlesInvalid = invalidBg !== 'rgba(0, 0, 0, 0)' && invalidBg !== 'transparent';

            output += `  Invalid token set: ${handlesInvalid ? 'Handled gracefully ✅' : 'Breaks component ❌'}\n`;
            output += `  Computed background: ${invalidBg}\n\n`;

            // Restore valid token
            document.documentElement.style.setProperty('--color-primary', '#2563eb');

            // Test 3: Rapid token changes
            output += 'TEST 3: Rapid Token Changes\n';
            const colors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff'];
            let rapidChangeWorks = true;

            for (let i = 0; i < colors.length; i++) {
                document.documentElement.style.setProperty('--color-primary', colors[i]);
                document.body.offsetHeight;

                const currentBg = getComputedStyle(primaryElement).backgroundColor;
                if (currentBg === 'rgba(0, 0, 0, 0)' || currentBg === 'transparent') {
                    rapidChangeWorks = false;
                    break;
                }
            }

            output += `  Rapid changes: ${rapidChangeWorks ? 'Stable ✅' : 'Unstable ❌'}\n\n`;

            // Restore original
            document.documentElement.style.setProperty('--color-primary', '#2563eb');

            const edgeCasesPass = hasFallback && handlesInvalid && rapidChangeWorks;
            output += `📊 EDGE CASE RESULTS:\n`;
            output += `   Fallback: ${hasFallback ? 'PASS ✅' : 'FAIL ❌'}\n`;
            output += `   Invalid Values: ${handlesInvalid ? 'PASS ✅' : 'FAIL ❌'}\n`;
            output += `   Rapid Changes: ${rapidChangeWorks ? 'PASS ✅' : 'FAIL ❌'}\n`;
            output += `   Overall: ${edgeCasesPass ? 'PASS ✅' : 'FAIL ❌'}\n`;

            testResults.edgeCases = {
                fallback: hasFallback,
                invalidValues: handlesInvalid,
                rapidChanges: rapidChangeWorks,
                status: edgeCasesPass ? 'PASS' : 'FAIL'
            };

            document.getElementById('test-output').textContent = output;
            updateTestSummary();
        }

        /**
         * Enhanced Debug: Visual Customizer Detailed Analysis
         */
        function debugVisualCustomizerDetailed() {
            console.log('🔬 Enhanced Visual Customizer debug...');

            let output = '🔬 ENHANCED VISUAL CUSTOMIZER DEBUG\n\n';

            // Step 1: Show current token values
            output += '📋 CURRENT TOKEN VALUES:\n';
            const foundationTokens = ['--color-primary', '--color-secondary', '--color-accent', '--color-surface'];
            foundationTokens.forEach(token => {
                const value = getComputedStyle(document.documentElement).getPropertyValue(token);
                output += `  ${token}: ${value.trim()}\n`;
            });

            // Step 2: Capture initial state
            output += '\n📸 INITIAL COMPONENT STATE:\n';
            const initialState = captureComponentStates();
            output += formatComponentStates(initialState);

            // Step 3: Apply tokens step by step
            output += '\n🔄 APPLYING FOUNDATION TOKENS FIRST...\n';
            Object.entries(testPalettes.customized).forEach(([prop, value]) => {
                document.documentElement.style.setProperty(prop, value);
                output += `  Applied: ${prop} = ${value}\n`;
            });

            // Force update and check intermediate state
            document.documentElement.offsetHeight;
            const intermediateState = captureComponentStates();

            output += '\n📸 STATE AFTER FOUNDATION TOKENS:\n';
            output += formatComponentStates(intermediateState);

            // Step 4: Apply component tokens
            output += '\n🔄 APPLYING COMPONENT-LEVEL TOKENS...\n';
            const componentTokens = {
                '--component-bg-color-primary': testPalettes.customized['--color-primary'],
                '--component-text-color-primary': '#ffffff',
                '--component-border-color-primary': testPalettes.customized['--color-primary'],
                '--component-bg-color-secondary': testPalettes.customized['--color-secondary'],
                '--component-text-color-secondary': '#ffffff',
                '--component-border-color-secondary': testPalettes.customized['--color-secondary'],
                '--component-bg-color-accent': testPalettes.customized['--color-accent'],
                '--component-text-color-accent': '#ffffff',
                '--component-border-color-accent': testPalettes.customized['--color-accent']
            };

            Object.entries(componentTokens).forEach(([prop, value]) => {
                document.documentElement.style.setProperty(prop, value);
                output += `  Applied: ${prop} = ${value}\n`;
            });

            // Force final update
            document.documentElement.offsetHeight;

            setTimeout(() => {
                const finalState = captureComponentStates();

                output += '\n📸 FINAL STATE AFTER ALL TOKENS:\n';
                output += formatComponentStates(finalState);

                // Comprehensive comparison
                output += '\n📊 COMPREHENSIVE CHANGE ANALYSIS:\n';
                output += '  Initial → Intermediate (Foundation Only):\n';
                const change1 = analyzeChangesEnhanced(initialState, intermediateState);
                output += change1.report.split('\n').map(line => '    ' + line).join('\n') + '\n';

                output += '  Intermediate → Final (+ Component Tokens):\n';
                const change2 = analyzeChangesEnhanced(intermediateState, finalState);
                output += change2.report.split('\n').map(line => '    ' + line).join('\n') + '\n';

                output += '  Overall: Initial → Final:\n';
                const changeOverall = analyzeChangesEnhanced(initialState, finalState);
                output += changeOverall.report.split('\n').map(line => '    ' + line).join('\n') + '\n';

                output += `\n🎯 FINAL RESULT:\n`;
                output += `  Foundation tokens changed components: ${change1.changedCount}/${change1.totalCount}\n`;
                output += `  Component tokens changed components: ${change2.changedCount}/${change2.totalCount}\n`;
                output += `  Overall components changed: ${changeOverall.changedCount}/${changeOverall.totalCount}\n`;
                output += `  Status: ${changeOverall.changedCount > 0 ? 'SUCCESS - Fix Working ✅' : 'ISSUE - No Changes Detected ❌'}\n`;

                document.getElementById('test-output').textContent = output;
            }, 150);
        }

        /**
         * Demonstrate Fix From Clean Baseline - Prove The Tokenization Fix Works
         */
        function demonstrateFixFromCleanBaseline() {
            console.log('🎯 Demonstrating tokenization fix from clean baseline...');

            let output = '🎯 TOKENIZATION FIX DEMONSTRATION\n\n';
            output += 'This test proves the Visual Customizer tokenization inheritance fix works!\n\n';

            // Step 1: Force complete reset to original blue theme
            output += '🔄 STEP 1: FORCING CLEAN RESET TO ORIGINAL THEME...\n';

            const originalTheme = {
                '--color-primary': '#2563eb',        // Original blue
                '--color-secondary': '#10b981',      // Original green
                '--color-accent': '#f59e0b',         // Original yellow
                '--color-surface': '#ffffff',        // Original white
                '--component-bg-color-primary': '#2563eb',
                '--component-text-color-primary': '#ffffff',
                '--component-border-color-primary': '#2563eb',
                '--component-bg-color-secondary': '#10b981',
                '--component-text-color-secondary': '#ffffff',
                '--component-border-color-secondary': '#10b981',
                '--component-bg-color-accent': '#f59e0b',
                '--component-text-color-accent': '#ffffff',
                '--component-border-color-accent': '#f59e0b'
            };

            Object.entries(originalTheme).forEach(([prop, value]) => {
                document.documentElement.style.setProperty(prop, value);
                output += `  Reset: ${prop} = ${value}\n`;
            });

            // Force DOM update
            document.documentElement.offsetHeight;

            setTimeout(() => {
                // Step 2: Capture clean baseline
                output += '\n📸 CLEAN BASELINE STATE (Original Blue Theme):\n';
                const cleanBaseline = captureComponentStates();
                output += formatComponentStates(cleanBaseline);

                // Step 3: Apply the Visual Customizer fix simulation
                output += '\n🎨 STEP 2: APPLYING VISUAL CUSTOMIZER FIX...\n';
                output += 'Simulating exactly what the fixed Visual Customizer does:\n\n';

                // Apply foundation tokens
                output += '  → Applying foundation tokens:\n';
                Object.entries(testPalettes.customized).forEach(([prop, value]) => {
                    document.documentElement.style.setProperty(prop, value);
                    output += `    ${prop} = ${value}\n`;
                });

                // Apply component-level tokens (THE FIX!)
                output += '\n  → Applying component-level tokens (THE FIX!):\n';
                const fixTokens = {
                    '--component-bg-color-primary': testPalettes.customized['--color-primary'],
                    '--component-text-color-primary': '#ffffff',
                    '--component-border-color-primary': testPalettes.customized['--color-primary'],
                    '--component-bg-color-secondary': testPalettes.customized['--color-secondary'],
                    '--component-text-color-secondary': '#ffffff',
                    '--component-border-color-secondary': testPalettes.customized['--color-secondary'],
                    '--component-bg-color-accent': testPalettes.customized['--color-accent'],
                    '--component-text-color-accent': '#ffffff',
                    '--component-border-color-accent': testPalettes.customized['--color-accent']
                };

                Object.entries(fixTokens).forEach(([prop, value]) => {
                    document.documentElement.style.setProperty(prop, value);
                    output += `    ${prop} = ${value}\n`;
                });

                // Force DOM update
                document.documentElement.offsetHeight;

                setTimeout(() => {
                    // Step 4: Capture final state
                    output += '\n📸 FINAL STATE (After Visual Customizer Fix Applied):\n';
                    const finalState = captureComponentStates();
                    output += formatComponentStates(finalState);

                    // Step 5: Analyze the transformation
                    output += '\n🎯 TRANSFORMATION ANALYSIS:\n';
                    const changes = analyzeChangesEnhanced(cleanBaseline, finalState);
                    output += changes.report;

                    // Step 6: Visual comparison
                    output += '\n🎨 VISUAL COMPARISON:\n';
                    Object.keys(cleanBaseline).forEach(selector => {
                        const name = selector.replace('[data-testid="', '').replace('"]', '');
                        const before = cleanBaseline[selector];
                        const after = finalState[selector];

                        const bgChanged = before.backgroundColor !== after.backgroundColor;
                        const colorChanged = before.color !== after.color;
                        const borderChanged = before.borderColor !== after.borderColor;

                        if (bgChanged || colorChanged || borderChanged) {
                            output += `  ${name}:\n`;
                            output += `    BEFORE: ${before.backgroundColor}\n`;
                            output += `    AFTER:  ${after.backgroundColor}\n`;
                            if (bgChanged) output += `    ✅ Background color successfully changed!\n`;
                            if (colorChanged) output += `    ✅ Text color successfully changed!\n`;
                            if (borderChanged) output += `    ✅ Border color successfully changed!\n`;
                            output += '\n';
                        }
                    });

                    // Step 7: Final verdict
                    output += '🏆 FINAL VERDICT:\n';
                    if (changes.changedCount > 0) {
                        output += `✅ SUCCESS! Visual Customizer tokenization fix is working perfectly!\n`;
                        output += `✅ ${changes.changedCount} out of ${changes.totalCount} components updated correctly\n`;
                        output += `✅ Button backgrounds AND text colors update consistently\n`;
                        output += `✅ Complete inheritance chain is functional\n\n`;
                        output += '🎉 The original issue is FIXED:\n';
                        output += '   ❌ OLD: Button backgrounds not updating\n';
                        output += '   ✅ NEW: Button backgrounds update properly\n';
                        output += '   ❌ OLD: Only text colors changing\n';
                        output += '   ✅ NEW: All colors change together\n';
                        output += '   ❌ OLD: Inconsistent after reload\n';
                        output += '   ✅ NEW: Consistent token inheritance\n';
                    } else {
                        output += `❌ Issue detected: Components did not change as expected\n`;
                    }

                    document.getElementById('test-output').textContent = output;

                    // Update test results
                    testResults.demonstrateFixFromCleanBaseline = {
                        changedComponents: changes.changedCount,
                        totalComponents: changes.totalCount,
                        status: changes.changedCount > 0 ? 'PASS' : 'FAIL'
                    };
                    updateTestSummary();

                }, 100);
            }, 200);
        }

        /**
         * Reset to baseline
         */
        function resetToBaseline() {
            console.log('🔄 Resetting to baseline...');

            // Reset all custom properties to original values
            Object.entries(testPalettes.original).forEach(([prop, value]) => {
                document.documentElement.style.setProperty(prop, value);
            });

            // Reset component tokens
            const componentResets = {
                '--component-bg-color': 'var(--color-surface)',
                '--component-text-color': 'var(--color-text-primary)',
                '--component-border-color': 'var(--color-border)',
                '--component-bg-color-primary': 'var(--color-primary)',
                '--component-text-color-primary': 'var(--color-primary-contrast)',
                '--component-border-color-primary': 'var(--color-primary)'
            };

            Object.entries(componentResets).forEach(([prop, value]) => {
                document.documentElement.style.setProperty(prop, value);
            });

            document.getElementById('test-output').textContent = '🔄 RESET TO BASELINE\n\nAll tokens have been reset to original values.\nRun tests again to verify baseline functionality.';

            // Clear test results
            testResults = {
                inheritanceChain: null,
                customizerUpdate: null,
                tokenCascade: null,
                edgeCases: null,
                timestamp: null
            };

            updateTestSummary();
        }

        /**
         * Helper Functions
         */
        function validateInheritanceChain(bgColor, textColor, borderColor, expectedType) {
            // Simple validation - in real implementation this would be more sophisticated
            const isNotTransparent = bgColor !== 'rgba(0, 0, 0, 0)' && bgColor !== 'transparent';
            const hasTextColor = textColor !== 'rgba(0, 0, 0, 0)' && textColor !== 'transparent';
            const hasBorderColor = borderColor !== 'rgba(0, 0, 0, 0)' && borderColor !== 'transparent';

            return isNotTransparent && hasTextColor && hasBorderColor;
        }

        function captureComponentStates() {
            const selectors = [
                '[data-testid="tokenized-default"]',
                '[data-testid="tokenized-primary"]',
                '[data-testid="tokenized-secondary"]',
                '[data-testid="tokenized-accent"]'
            ];

            const states = {};
            selectors.forEach(selector => {
                const element = document.querySelector(selector);
                if (element) {
                    const computed = getComputedStyle(element);
                    states[selector] = {
                        backgroundColor: computed.backgroundColor,
                        color: computed.color,
                        borderColor: computed.borderColor
                    };
                }
            });

            return states;
        }

        function formatComponentStates(states) {
            let output = '';
            Object.entries(states).forEach(([selector, state]) => {
                const name = selector.replace('[data-testid="', '').replace('"]', '');
                output += `  ${name}:\n`;
                output += `    BG: ${state.backgroundColor}\n`;
                output += `    Color: ${state.color}\n`;
                output += `    Border: ${state.borderColor}\n`;
            });
            return output;
        }

        function applyComprehensiveTokenUpdate() {
            // Apply foundation tokens
            Object.entries(testPalettes.customized).forEach(([prop, value]) => {
                document.documentElement.style.setProperty(prop, value);
            });

            // CRITICAL: Apply component-level tokens (this is the fix!)
            // Primary component tokens
            document.documentElement.style.setProperty('--component-bg-color-primary', 'var(--color-primary)');
            document.documentElement.style.setProperty('--component-text-color-primary', '#ffffff');
            document.documentElement.style.setProperty('--component-border-color-primary', 'var(--color-primary)');

            // Secondary component tokens
            document.documentElement.style.setProperty('--component-bg-color-secondary', 'var(--color-secondary)');
            document.documentElement.style.setProperty('--component-text-color-secondary', '#ffffff');
            document.documentElement.style.setProperty('--component-border-color-secondary', 'var(--color-secondary)');

            // Accent component tokens
            document.documentElement.style.setProperty('--component-bg-color-accent', 'var(--color-accent)');
            document.documentElement.style.setProperty('--component-text-color-accent', '#ffffff');
            document.documentElement.style.setProperty('--component-border-color-accent', 'var(--color-accent)');

            // Also update palette tokens
            document.documentElement.style.setProperty('--palette-primary', 'var(--color-primary)');
            document.documentElement.style.setProperty('--palette-secondary', 'var(--color-secondary)');

            // ENHANCED: Apply contrast and hover tokens too
            document.documentElement.style.setProperty('--color-primary-contrast', '#ffffff');
            document.documentElement.style.setProperty('--color-secondary-contrast', '#ffffff');
            document.documentElement.style.setProperty('--color-accent-contrast', '#ffffff');

            // Force multiple DOM recalculations to ensure all tokens update
            document.documentElement.offsetHeight;

            // Wait a bit for CSS custom property inheritance to propagate
            setTimeout(() => {
                document.body.offsetHeight;
            }, 10);
        }

        function analyzeChanges(before, after) {
            let changedCount = 0;
            let totalCount = Object.keys(before).length;
            let report = '';

            Object.keys(before).forEach(selector => {
                const name = selector.replace('[data-testid="', '').replace('"]', '');
                const beforeState = before[selector];
                const afterState = after[selector];

                const bgChanged = beforeState.backgroundColor !== afterState.backgroundColor;
                const colorChanged = beforeState.color !== afterState.color;
                const borderChanged = beforeState.borderColor !== afterState.borderColor;

                if (bgChanged || colorChanged || borderChanged) {
                    changedCount++;
                    report += `  ${name}: `;
                    if (bgChanged) report += '🔴 BG-CHANGED ';
                    if (colorChanged) report += '🟡 COLOR-CHANGED ';
                    if (borderChanged) report += '🔵 BORDER-CHANGED ';
                    report += '\n';
                } else {
                    report += `  ${name}: ⚪ NO-CHANGE\n`;
                }
            });

            return {
                changedCount,
                totalCount,
                allChanged: changedCount === totalCount,
                report
            };
        }

        function analyzeChangesEnhanced(before, after) {
            let changedCount = 0;
            let totalCount = Object.keys(before).length;
            let report = '';
            let details = '';

            Object.keys(before).forEach(selector => {
                const name = selector.replace('[data-testid="', '').replace('"]', '');
                const beforeState = before[selector];
                const afterState = after[selector];

                const bgChanged = beforeState.backgroundColor !== afterState.backgroundColor;
                const colorChanged = beforeState.color !== afterState.color;
                const borderChanged = beforeState.borderColor !== afterState.borderColor;

                if (bgChanged || colorChanged || borderChanged) {
                    changedCount++;
                    report += `  ${name}: `;
                    if (bgChanged) report += '🔴 BG-CHANGED ';
                    if (colorChanged) report += '🟡 COLOR-CHANGED ';
                    if (borderChanged) report += '🔵 BORDER-CHANGED ';
                    report += '\n';

                    if (bgChanged) {
                        details += `  ${name}: BG-CHANGED\n`;
                    }
                    if (colorChanged) {
                        details += `  ${name}: COLOR-CHANGED\n`;
                    }
                    if (borderChanged) {
                        details += `  ${name}: BORDER-CHANGED\n`;
                    }
                } else {
                    report += `  ${name}: ⚪ NO-CHANGE\n`;
                }
            });

            return {
                changedCount,
                totalCount,
                allChanged: changedCount === totalCount,
                report,
                details
            };
        }

        function generateDetailedColorComparison(before, after) {
            let comparison = '';

            Object.keys(before).forEach(selector => {
                const name = selector.replace('[data-testid="', '').replace('"]', '');
                const beforeState = before[selector];
                const afterState = after[selector];

                const bgChanged = beforeState.backgroundColor !== afterState.backgroundColor;
                const colorChanged = beforeState.color !== afterState.color;
                const borderChanged = beforeState.borderColor !== afterState.borderColor;

                if (bgChanged || colorChanged || borderChanged) {
                    comparison += `  ${name}:\n`;
                    comparison += `    BEFORE: ${beforeState.backgroundColor} ${beforeState.color} ${beforeState.borderColor}\n`;
                    comparison += `    AFTER: ${afterState.backgroundColor} ${afterState.color} ${afterState.borderColor}\n`;
                }
            });

            return comparison;
        }

        function updateTestSummary() {
            const summary = document.getElementById('test-summary');
            let html = '<div class="comparison-grid">';

            // Test 1: Inheritance Chain
            if (testResults.inheritanceChain) {
                const test = testResults.inheritanceChain;
                html += `
                    <div class="comparison-section">
                        <h3>🔍 Inheritance Chain Test <span class="status-indicator ${test.status === 'PASS' ? 'status-pass' : 'status-fail'}">${test.status}</span></h3>
                        <p>Passed: ${test.passed}/${test.total} (${test.passRate}%)</p>
                    </div>
                `;
            }

            // Test 2: Customizer Update
            if (testResults.customizerUpdate) {
                const test = testResults.customizerUpdate;
                html += `
                    <div class="comparison-section">
                        <h3>🎨 Customizer Update Test <span class="status-indicator ${test.status === 'PASS' ? 'status-pass' : 'status-fail'}">${test.status}</span></h3>
                        <p>Changed: ${test.changedComponents}/${test.totalComponents} components</p>
                    </div>
                `;
            }

            // Test 3: Token Cascade
            if (testResults.tokenCascade) {
                const test = testResults.tokenCascade;
                html += `
                    <div class="comparison-section">
                        <h3>⚡ Token Cascade Test <span class="status-indicator ${test.status === 'PASS' ? 'status-pass' : 'status-fail'}">${test.status}</span></h3>
                        <p>Foundation: ${test.foundation ? '✅' : '❌'} | Component: ${test.component ? '✅' : '❌'} | Palette: ${test.palette ? '✅' : '❌'}</p>
                    </div>
                `;
            }

            // Test 4: Edge Cases
            if (testResults.edgeCases) {
                const test = testResults.edgeCases;
                html += `
                    <div class="comparison-section">
                        <h3>🧩 Edge Cases Test <span class="status-indicator ${test.status === 'PASS' ? 'status-pass' : 'status-fail'}">${test.status}</span></h3>
                        <p>Fallback: ${test.fallback ? '✅' : '❌'} | Invalid: ${test.invalidValues ? '✅' : '❌'} | Rapid: ${test.rapidChanges ? '✅' : '❌'}</p>
                    </div>
                `;
            }

            html += '</div>';

            // Overall status
            const completedTests = Object.values(testResults).filter(test => test !== null).length;
            const passedTests = Object.values(testResults).filter(test => test && test.status === 'PASS').length;

            if (completedTests > 0) {
                const overallPass = passedTests === completedTests;
                html += `
                    <div style="text-align: center; margin-top: 2rem; padding: 1rem; border-radius: 8px; background: ${overallPass ? '#d4edda' : '#f8d7da'}; color: ${overallPass ? '#155724' : '#721c24'};">
                        <h3>Overall Test Status: ${overallPass ? 'ALL TESTS PASS ✅' : 'SOME TESTS FAIL ❌'}</h3>
                        <p>Completed: ${completedTests}/4 tests | Passed: ${passedTests}/${completedTests}</p>
                    </div>
                `;
            }

            summary.innerHTML = html;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('✅ Tokenization Fix Verification Test initialized');
            console.log('🎯 Ready to test complete inheritance chain fix');
        });
    </script>
</body>
</html>
